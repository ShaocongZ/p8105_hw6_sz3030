p8105\_hw6\_sz3030
================
Shaocong Zhang
12/4/2021

# Problem 1

``` r
library(tidyverse)
```

    ## ── Attaching packages ─────────────────────────────────────── tidyverse 1.3.1 ──

    ## ✓ ggplot2 3.3.5     ✓ purrr   0.3.4
    ## ✓ tibble  3.1.4     ✓ dplyr   1.0.7
    ## ✓ tidyr   1.1.3     ✓ stringr 1.4.0
    ## ✓ readr   2.0.1     ✓ forcats 0.5.1

    ## ── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
    ## x dplyr::filter() masks stats::filter()
    ## x dplyr::lag()    masks stats::lag()

``` r
library(modelr)
library(leaps)
library(mgcv)
```

    ## Loading required package: nlme

    ## 
    ## Attaching package: 'nlme'

    ## The following object is masked from 'package:dplyr':
    ## 
    ##     collapse

    ## This is mgcv 1.8-36. For overview type 'help("mgcv-package")'.

### Load the dataset

``` r
birthweight = read_csv("./data/birthweight.csv")
```

    ## Rows: 4342 Columns: 20

    ## ── Column specification ────────────────────────────────────────────────────────
    ## Delimiter: ","
    ## dbl (20): babysex, bhead, blength, bwt, delwt, fincome, frace, gaweeks, malf...

    ## 
    ## ℹ Use `spec()` to retrieve the full column specification for this data.
    ## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.

### Clean the data

``` r
birthweight = 
  birthweight %>% 
  janitor::clean_names() %>%
  mutate(
    babysex = as.factor(babysex),
    babysex = fct_recode(babysex, "male" = "1", 
                         "female" = "2"),
    frace = as.factor(frace),
    frace = fct_recode(frace, "white" = "1", 
                       "black" = "2", 
                       "asian" = "3", 
                       "puerto rican" = "4", 
                       "other" = "8", 
                       "unknown" = "9"),
    malform = as.factor(malform),
    malform = fct_recode(malform, "absent" = "0", 
                         "present" = "1"),
    mrace = as.factor(mrace),
    mrace = fct_recode(mrace, "white" = "1", 
                       "black" = "2", 
                       "asian" = "3", 
                       "puerto rican" = "4"))
```

    ## Warning: Unknown levels in `f`: 9

### Check for missing data

``` r
sum(is.na(birthweight))
```

    ## [1] 0

There is 0 NA value in the dataset.

### model selection

``` r
full.mod = lm(bwt  ~., data = birthweight)

step(full.mod, direction = 'backward', trace = FALSE)
```

    ## 
    ## Call:
    ## lm(formula = bwt ~ babysex + bhead + blength + delwt + fincome + 
    ##     gaweeks + mheight + mrace + parity + ppwt + smoken, data = birthweight)
    ## 
    ## Coefficients:
    ##       (Intercept)      babysexfemale              bhead            blength  
    ##         -6098.822             28.558            130.777             74.947  
    ##             delwt            fincome            gaweeks            mheight  
    ##             4.107              0.318             11.592              6.594  
    ##        mraceblack         mraceasian  mracepuerto rican             parity  
    ##          -138.792            -74.887           -100.678             96.305  
    ##              ppwt             smoken  
    ##            -2.676             -4.843

In the model selection process, I use the backward selection method,
which start with the full model and exclude the covariates to decrease
the AIC value.

``` r
# Thus, the final model should be
final.mod = lm(formula = bwt ~ babysex + bhead + blength + delwt + fincome + 
    gaweeks + mheight + mrace + parity + ppwt + smoken, data = birthweight)

birthweight %>%
  add_predictions(final.mod) %>%
  add_residuals(final.mod) %>%
  ggplot(aes(x = pred, y = resid)) + 
  geom_point() + 
  labs(
    title = "Residuals v.s. fitted values",
    x = "Fitted values",
    y = "Residuals"
  )
```

![](p8105_hw6_sz3030_files/figure-gfm/unnamed-chunk-6-1.png)<!-- -->

### Compare the model to two others

``` r
set.seed(1)

cv_df = 
  crossv_mc(birthweight, 100) %>% 
  mutate(
    maineffect_mod = map(train, ~lm(bwt ~ blength + gaweeks, data = .x)),
    final_mod = map(train, ~lm(bwt ~ babysex + bhead + blength + delwt + fincome + gaweeks + 
                         mheight + mrace + parity + ppwt + smoken, data = .x)),
    complex_mod =  map(train, ~lm(bwt ~ bhead * blength * babysex, data = .x))) %>% 
  mutate(
    rmse_maineffect = map2_dbl(maineffect_mod, test, rmse),
    rmse_final = map2_dbl(final_mod, test, rmse),
    rmse_complex = map2_dbl(complex_mod, test, rmse)) 
```

    ## Warning in predict.lm(model, data): prediction from a rank-deficient fit may be
    ## misleading

``` r
cv_df %>% 
  select(starts_with("rmse")) %>% 
  pivot_longer(
    everything(),
    names_to = "model", 
    values_to = "rmse",
    names_prefix = "rmse_") %>% 
  mutate(model = fct_inorder(model)) %>% 
  ggplot(aes(x = model, y = rmse)) + geom_violin()
```

![](p8105_hw6_sz3030_files/figure-gfm/unnamed-chunk-7-1.png)<!-- -->

It is obvious that the final model, which was selected after the
backward selection, performs best among all the three model. The
maineffect model, which only contains length at birth and gestational
age as predictors, performs worst due to its highest RMSE. The complex
model, which contains head circumference, length, sex, and all
interactions, performs good. However, due to its complexity in model
computing and interpretation, I would not try to use it. The “final
model” would be the best choice.

# Problem 2
